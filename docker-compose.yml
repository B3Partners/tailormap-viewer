version: '3.9'

# See README.md for usage details

services:
  web:
    image: ghcr.io/b3partners/tailormap-viewer:snapshot
    depends_on:
      - api
      - admin
    profiles:
      - http
    ports:
      - "80:80"

  # The same as web, but without port 80 exposed -- when using a reverse proxy. Already has Traefik labels.
  web-proxied:
    image: ghcr.io/b3partners/tailormap-viewer:snapshot
    depends_on:
      - api
      - admin
    profiles:
      - proxied
    labels:
      traefik.http.routers.tailormap-snapshot.rule: "Host(`${HOSTNAME:-snapshot.tailormap.nl}`)"
      traefik.http.routers.tailormap-snapshot.tls: "true"
      traefik.http.routers.tailormap-snapshot.tls.certresolver: "letsencrypt"
      traefik.http.services.tailormap-snapshot.loadbalancer.server.port: 80

  api:
    image: ghcr.io/b3partners/tailormap-api:snapshot
    environment:
      SPRING_DATASOURCE_URL: jdbc:postgresql://db/tailormap
      DB_PASSWORD: ${TAILORMAP_DB_PASSWORD:-tailormap}

  admin:
    image: ghcr.io/b3partners/tailormap-admin:snapshot
    environment:
      CATALINA_OPTS: -DPG_HOST=db -DPG_PORT=5432 -DPG_DATABASE=tailormap -DDB_NAME=tailormap -DDB_USER=tailormap -DDB_PASSWORD=${TAILORMAP_DB_PASSWORD:-tailormap} -DURL_SCHEME=http

  db:
    build:
      context: ./config/db
    environment:
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-postgres}
      TAILORMAP_PASSWORD: ${TAILORMAP_DB_PASSWORD:-tailormap}
      TM_VERSION: ${TM_VERSION:-5.9.12}
      # use
      #   docker run --rm tomcat:9.0-jre11-temurin /usr/local/tomcat/bin/digest.sh -a PBKDF2WithHmacSHA512 -i 100000 -k 256 -s 16 -h org.apache.catalina.realm.SecretKeyCredentialHandler <PASSWORD>
      # to create this password hash for the admin user
      TAILORMAP_ADMIN_HASHED_PASSWORD: '${TAILORMAP_ADMIN_HASHED_PASSWORD:-720230f982b72beaeaa9aed0cb9bef22$100000$51a21a475cbf417e858ce64645f6b6bebcdfadc303c6ee477bdeb2eb352e29bb}'
    volumes:
      - config-db:/var/lib/postgresql/data
    healthcheck:
      interval: 1m
      timeout: 5s
      retries: 5
      test: su postgres -c pg_isready

volumes:
  config-db:
